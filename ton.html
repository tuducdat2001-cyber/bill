<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý đơn hàng vận chuyển</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #d9534f; text-align: center; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .warning { background-color: #fff3cd !important; }
        .loading { color: #31708f; font-style: italic; }
        .error { color: #d9534f; }
        .button { background-color: #4CAF50; border: none; color: white; padding: 10px 15px; text-align: center; text-decoration: none; display: inline-block; font-size: 14px; margin: 10px 2px; cursor: pointer; border-radius: 4px; }
        .button.print { background-color: #337ab7; }
        .button.edit { background-color: #f0ad4e; }
        .container { overflow-x: auto; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: inline-block; width: 150px; font-weight: bold; }
        .form-group input, .form-group select { width: 200px; padding: 5px; }
        @media print {
            body { margin: 0; padding: 10px; }
            .no-print { display: none !important; }
            table { font-size: 10px; width: 100%; }
            th, td { padding: 5px; }
        }

        /* Làm nổi bật cột Số Bill */
        #resultTable th.bill-col,
        #resultTable td.bill-col {
            background: #fff5e6;
            font-weight: 700;
            color: #c25700;
            border-left: 2px solid #f5b76b;
            border-right: 2px solid #f5b76b;
            cursor: copy;
        }
        @media print {
            #resultTable th.bill-col,
            #resultTable td.bill-col {
                background: #ffffcc !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                border-left: 2px solid #999;
                border-right: 2px solid #999;
            }
        }
    </style>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <h1>QUẢN LÝ ĐƠN HÀNG VẬN CHUYỂN</h1>
    <div class="no-print">
        <button id="exportBtn" class="button" style="display: none;">Xuất Excel</button>
        <button id="printBtn" class="button print" style="display: none;">In báo cáo</button>
        <button id="editBtn" class="button edit" style="display: none;">Sửa dữ liệu</button>
    </div>
    <div id="status" class="loading">Đang tải dữ liệu...</div>
    <div class="container">
        <table id="resultTable" style="display: none;">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Ngày bốc hàng</th>
                    <th>Tỉnh nhận</th>
                    <th>Khách hàng</th>
                    <th>Dịch vụ GTGT</th>
                    <th>Nội dung hàng</th>
                    <th>Chưa xếp</th>
                    <th>Đơn vị</th>
                    <th>COD</th>
                    <th>SĐT nhận</th>
                    <th>Địa chỉ nhận</th>
                    <th class="bill-col">Số Bill</th>
                    <th>Trọng lượng chưa xếp</th>
                    <th>Thể tích chưa xếp</th>
                </tr>
            </thead>
            <tbody id="billTable"></tbody>
        </table>
    </div>

    <!-- Modal chỉnh sửa -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Chỉnh sửa thông tin đơn hàng</h2>
            <form id="editForm">
                <div class="form-group"><label for="editBillNumber">Số Bill:</label><input type="text" id="editBillNumber" readonly></div>
                <div class="form-group"><label for="editCustomer">Khách hàng:</label><input type="text" id="editCustomer"></div>
                <div class="form-group"><label for="editService">Dịch vụ GTGT:</label><input type="text" id="editService"></div>
                <div class="form-group"><label for="editContent">Nội dung hàng:</label><input type="text" id="editContent"></div>
                <div class="form-group"><label for="editCOD">COD:</label><input type="text" id="editCOD"></div>
                <div class="form-group"><label for="editPhone">SĐT nhận:</label><input type="text" id="editPhone"></div>
                <div class="form-group"><label for="editAddress">Địa chỉ nhận:</label><input type="text" id="editAddress"></div>
                <div class="form-group"><label for="editWeight">Trọng lượng chưa xếp:</label><input type="number" step="0.01" id="editWeight"></div>
                <div class="form-group"><label for="editVolume">Thể tích chưa xếp:</label><input type="number" step="0.01" id="editVolume"></div>
                <div class="form-group"><label for="editPacked">Tổng số kiện đã xếp:</label><input type="number" id="editPacked"></div>
                <button type="submit" class="button">Lưu thay đổi</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwbiLYAy1-FvBceJ0ir1XqJ9yzu-SEkhp6UT4uHTKGpGDNXIHMuhvkWca0Kz1HzLIqF/exec?all=1";
        let currentData = {};
        const priorityMap = {};

        const normalizeProvince = s => (s || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
        const getPriority = tinh => priorityMap[normalizeProvince(tinh)] ?? 0;
        const parseVnDate = s => { const p = (s || "").split("/"); return p.length===3 ? new Date(+p[2], p[1]-1, +p[0]) : new Date(s); };

        function showStatus(msg, err=false){
            const el=document.getElementById('status');
            el.textContent=msg;
            el.className=err?'error':'loading';
        }

        async function fetchData(){
            showStatus('Đang tải dữ liệu...');
            try{
                const res=await fetch(API_URL);
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                const data=await res.json();
                if(!data.data || !data.data.Bill) throw new Error('Sai cấu trúc dữ liệu');
                currentData=data.data;

                // map ưu tiên tỉnh từ bảng "Phụ"
                if(Array.isArray(currentData["Phụ"])){
                    currentData["Phụ"].forEach(r=>{
                        priorityMap[normalizeProvince(r.tinh)] = parseInt(r.uu_tien,10) || 0;
                    });
                }

                processData(currentData);
            }catch(e){
                console.error(e);
                showStatus('Lỗi: '+e.message,true);
            }
        }

        function processData(data){
            // tổng số kiện đã xếp theo bill
            const sumPacked={};
            (data["Xếp hàng"]||[]).forEach(i=>{
                sumPacked[i.bill] = (sumPacked[i.bill]||0) + (parseInt(i.so_kien)||0);
            });

            // các bill chưa xếp đủ
            let bills=(data.Bill||[]).filter(b=>{
                const billKien=parseInt(b.so_kien)||0;
                const packed=sumPacked[b.so_bill]||0;
                return billKien > packed;
            });

            // Tạo danh sách các tỉnh duy nhất kèm ưu tiên
            const uniqueProvinces = [...new Set(bills.map(b => b.tinh_nhan))]
                .filter(province => province) // Loại bỏ các giá trị undefined/null
                .map(province => ({
                    name: province,
                    priority: getPriority(province)
                }))
                .sort((a, b) => {
                    // Sắp xếp các tỉnh theo ưu tiên, cùng ưu tiên thì sắp theo tên
                    if (a.priority === 0 && b.priority === 0) return a.name.localeCompare(b.name);
                    if (a.priority === 0) return 1;
                    if (b.priority === 0) return -1;
                    return a.priority !== b.priority 
                        ? a.priority - b.priority 
                        : a.name.localeCompare(b.name);
                });

            // Sắp xếp bills: đầu tiên theo thứ tự tỉnh đã sắp xếp, sau đó theo ngày
            bills.sort((a, b) => {
                const provinceA = uniqueProvinces.findIndex(p => p.name === a.tinh_nhan);
                const provinceB = uniqueProvinces.findIndex(p => p.name === b.tinh_nhan);
                
                if (provinceA !== provinceB) {
                    return provinceA - provinceB;
                }
                
                // Cùng tỉnh thì sắp theo ngày (mới trước)
                return parseVnDate(b.ngay_boc) - parseVnDate(a.ngay_boc);
            });

            const tb=document.getElementById('billTable');
            tb.innerHTML='';

            if(!bills.length){
                showStatus('Tất cả đơn hàng đã xếp đủ');
                return;
            }

            document.getElementById('resultTable').style.display='table';
            document.getElementById('exportBtn').style.display='inline-block';
            document.getElementById('printBtn').style.display='inline-block';
            document.getElementById('editBtn').style.display='inline-block';
            showStatus(`Tìm thấy ${bills.length} đơn hàng chưa xếp đủ`);

            let currentProvince = null;

            bills.forEach((b, index)=>{
                const billKien=parseInt(b.so_kien)||0;
                const packed=sumPacked[b.so_bill]||0;
                const diff=billKien-packed;

                // TL/TT chưa xếp theo tỷ lệ chưa xếp
                const ratio = billKien ? (packed / billKien) : 0;
                const tlUn = (parseFloat(b.trong_luong_thuc)||0) * (1 - ratio);
                const ttUn = (parseFloat(b.the_tich)||0) * (1 - ratio);

                const tr=document.createElement('tr');
                if(diff>0) tr.classList.add('warning');

                // Thêm dòng phân cách khi tỉnh thay đổi
                if (currentProvince !== b.tinh_nhan) {
                    currentProvince = b.tinh_nhan;
                    if (index > 0) {
                        const separator = document.createElement('tr');
                        separator.innerHTML = `<td colspan="14" style="background-color: #e9e9e9; font-weight: bold;">${currentProvince || 'Không xác định'}</td>`;
                        tb.appendChild(separator);
                    }
                }

                // Để trống cột STT như yêu cầu
                tr.innerHTML = `
                    <td></td>
                    <td>${b.ngay_boc || ''}</td>
                    <td>${b.tinh_nhan || ''}</td>
                    <td>${b.ten_khach_gui || ''}</td>
                    <td>${b.dich_vu_gtgt || ''}</td>
                    <td>${b.noi_dung_hang_hoa || ''}</td>
                    <td>${diff}</td>
                    <td>kiện</td>
                    <td>${b.cod || ''}</td>
                    <td>${b.st_khach_nhan || ''}</td>
                    <td>${b.ia_chi_nhan || ''}</td>
                    <td class="bill-col" title="Click để copy">${b.so_bill}</td>
                    <td>${tlUn.toFixed(2)}</td>
                    <td>${ttUn.toFixed(2)}</td>
                `;

                tr.addEventListener('click',()=>openEditModal(b, packed, tlUn, ttUn));
                tb.appendChild(tr);
            });
        }

        function openEditModal(bill, packed, w, v){
            const m=document.getElementById('editModal');
            document.getElementById('editBillNumber').value=bill.so_bill;
            document.getElementById('editCustomer').value=bill.ten_khach_gui||'';
            document.getElementById('editService').value=bill.dich_vu_gtgt||'';
            document.getElementById('editContent').value=bill.noi_dung_hang_hoa||'';
            document.getElementById('editCOD').value=bill.cod||'';
            document.getElementById('editPhone').value=bill.st_khach_nhan||'';
            document.getElementById('editAddress').value=bill.ia_chi_nhan||'';
            document.getElementById('editWeight').value=w.toFixed(2);
            document.getElementById('editVolume').value=v.toFixed(2);
            document.getElementById('editPacked').value=packed;

            m.style.display='block';
            document.querySelector('.close').onclick=()=>m.style.display='none';
            window.onclick=e=>{ if(e.target==m) m.style.display='none'; };
        }

        document.getElementById('editForm').addEventListener('submit',e=>{
            e.preventDefault();
            const id=document.getElementById('editBillNumber').value;
            const idx=currentData.Bill.findIndex(b=>b.so_bill===id);
            if(idx>-1){
                currentData.Bill[idx].ten_khach_gui=document.getElementById('editCustomer').value;
                currentData.Bill[idx].dich_vu_gtgt=document.getElementById('editService').value;
                currentData.Bill[idx].noi_dung_hang_hoa=document.getElementById('editContent').value;
                currentData.Bill[idx].cod=document.getElementById('editCOD').value;
                currentData.Bill[idx].st_khach_nhan=document.getElementById('editPhone').value;
                currentData.Bill[idx].ia_chi_nhan=document.getElementById('editAddress').value;
                currentData.Bill[idx].trong_luong_thuc=parseFloat(document.getElementById('editWeight').value)||0;
                currentData.Bill[idx].the_tich=parseFloat(document.getElementById('editVolume').value)||0;
            }
            document.getElementById('editModal').style.display='none';
            processData(currentData);
        });

        document.getElementById('exportBtn').addEventListener('click',()=>{
            const wb=XLSX.utils.table_to_book(document.getElementById('resultTable'));
            XLSX.writeFile(wb,'Don_hang_chua_xep_du.xlsx');
        });

        document.getElementById('printBtn').addEventListener('click',()=>{
            const c=`<h1 style="text-align:center;margin-bottom:20px;">BÁO CÁO ĐƠN HÀNG CHƯA XẾP ĐỦ</h1>
                <div style="margin-bottom:15px;"><strong>Ngày in:</strong> ${new Date().toLocaleDateString()} |
                <strong>Tổng số đơn:</strong> ${document.getElementById('billTable').children.length}</div>
                ${document.getElementById('resultTable').outerHTML}
                <div style="text-align:right;margin-top:20px;font-style:italic;">Người in: ______________________</div>`;
            const w=window.open('','','width=1000,height=700');
            w.document.write(`<html><head><title>Báo cáo</title><style>
                body{font-family:Arial;margin:15px;}table{border-collapse:collapse;width:100%;font-size:10px;}
                th,td{border:1px solid #ddd;padding:4px;text-align:left;}th{background:#f2f2f2;}
                .warning{background:#fff3cd!important;}@page{size:A4 landscape;margin:10mm;}
                #resultTable th.bill-col,#resultTable td.bill-col{
                    background:#ffffcc !important;
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                    border-left:2px solid #999;border-right:2px solid #999;
                    font-weight:700;color:#000;
                }
            </style></head><body onload="window.print();window.close()">${c}</body></html>`);
            w.document.close();
        });

        document.getElementById('editBtn').addEventListener('click',()=>{
            const r=document.querySelector('#billTable tr');
            if(r){
                const id = r.cells[11].textContent;
                const b = currentData.Bill.find(x=>x.so_bill===id);
                if(b){
                    const packed = parseInt(document.getElementById('editPacked').value)||0;
                    const weight = parseFloat(r.cells[12].textContent)||0;
                    const volume = parseFloat(r.cells[13].textContent)||0;
                    openEditModal(b, packed, weight, volume);
                }
            } else {
                alert('Không có dữ liệu để chỉnh sửa');
            }
        });

        document.getElementById('billTable').addEventListener('click', (e)=>{
            const cell = e.target.closest('td.bill-col');
            if(!cell) return;
            e.stopPropagation();
            const text = cell.textContent.trim();
            if(!text) return;
            (navigator.clipboard && navigator.clipboard.writeText)
                ? navigator.clipboard.writeText(text).then(()=>{
                    cell.title = 'Đã copy!';
                    setTimeout(()=>cell.title='', 800);
                }).catch(()=>{})
                : (function(){ 
                    const ta=document.createElement('textarea'); ta.value=text;
                    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
                    document.body.removeChild(ta);
                })();
        });

        window.onload=fetchData;
    </script>
</body>
</html>
