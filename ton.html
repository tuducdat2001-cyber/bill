<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiểm tra đơn hàng chưa xếp đủ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            color: #d9534f;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .warning {
            background-color: #fff3cd !important;
        }
        .loading {
            color: #31708f;
            font-style: italic;
        }
        .error {
            color: #d9534f;
        }
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        .container {
            overflow-x: auto;
        }
    </style>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <h1>Đơn hàng chưa xếp đủ số kiện</h1>
    <button id="exportBtn" class="button" style="display: none;">Xuất Excel</button>
    <div id="status" class="loading">Đang tải dữ liệu...</div>
    <div class="container">
        <table id="resultTable" style="display: none;">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Ngày bốc hàng</th>
                    <th>Tỉnh nhận</th>
                    <th>Khách hàng</th>
                    <th>Chưa giao</th>
                    <th>Điểm đến</th>
                    <th>Người nhận</th>
                    <th>Địa chỉ nhận</th>
                    <th>SĐT nhận</th>
                    <th>Số Bill</th>
                    <th>Trọng lượng chưa xếp</th>
                    <th>Thể tích chưa xếp</th>
                    <th>Số kiện (Bill)</th>
                    <th>Tổng số kiện đã xếp</th>
                </tr>
            </thead>
            <tbody id="billTable">
                <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        // URL API của bạn
        const API_URL = "https://script.google.com/macros/s/AKfycbwbiLYAy1-FvBceJ0ir1XqJ9yzu-SEkhp6UT4uHTKGpGDNXIHMuhvkWca0Kz1HzLIqF/exec?all=1";
        
        // Hiển thị trạng thái
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = isError ? 'error' : 'loading';
        }

        // Lấy dữ liệu từ API
        async function fetchData() {
            showStatus('Đang tải dữ liệu...');
            
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`Lỗi HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Kiểm tra cấu trúc dữ liệu
                if (!data.data || !data.data.Bill || !data.data["Xếp hàng"]) {
                    throw new Error('Dữ liệu không đúng định dạng');
                }
                
                processData(data.data);
            } catch (error) {
                showStatus('Lỗi khi tải dữ liệu: ' + error.message, true);
                console.error('Lỗi:', error);
            }
        }

        // Xử lý dữ liệu
        function processData(data) {
            // Tính tổng số kiện đã xếp cho từng bill
            const xepHangSummary = {};
            data["Xếp hàng"].forEach(item => {
                if (!xepHangSummary[item.bill]) {
                    xepHangSummary[item.bill] = 0;
                }
                xepHangSummary[item.bill] += parseInt(item.so_kien) || 0;
            });

            // Tìm các bill có số kiện > tổng số kiện đã xếp
            const billsWithIncompletePacking = data.Bill.filter(bill => {
                const billKien = parseInt(bill.so_kien) || 0;
                const totalPacked = xepHangSummary[bill.so_bill] || 0;
                return billKien > totalPacked;
            });

            // Hiển thị kết quả
            const tableBody = document.getElementById('billTable');
            tableBody.innerHTML = ''; // Xóa nội dung cũ
            
            if (billsWithIncompletePacking.length === 0) {
                showStatus('Tất cả đơn hàng đã được xếp đủ số kiện');
                return;
            }

            // Hiển thị bảng kết quả
            document.getElementById('resultTable').style.display = 'table';
            document.getElementById('exportBtn').style.display = 'inline-block';
            showStatus(`Tìm thấy ${billsWithIncompletePacking.length} đơn hàng chưa xếp đủ`);

            billsWithIncompletePacking.forEach((bill, index) => {
                const billKien = parseInt(bill.so_kien) || 0;
                const totalPacked = xepHangSummary[bill.so_bill] || 0;
                const diff = billKien - totalPacked;
                
                // Tính trọng lượng và thể tích chưa xếp (tính bằng đơn vị thực tế)
                const tlBill = parseFloat(bill.trong_luong_thuc) || 0;
                const ttBill = parseFloat(bill.the_tich) || 0;
                const ratioPacked = totalPacked / billKien;
                
                const tlUnpacked = tlBill * (1 - ratioPacked);
                const ttUnpacked = ttBill * (1 - ratioPacked);
                
                const row = document.createElement('tr');
                if (diff > 0) {
                    row.classList.add('warning');
                }
                
                row.innerHTML = `
                    <td></td>
                    <td>${bill.ngay_boc || ''}</td>
                    <td>${bill.tinh_nhan || ''}</td>
                    <td>${bill.ten_khach_gui || ''}</td>
                    <td>${diff}</td>
                    <td>${bill.tinh_nhan || ''}</td>
                    <td>${bill.ten_khach_nhan || ''}</td>
                    <td>${bill.ia_chi_nhan || ''}</td>
                    <td>${bill.st_khach_nhan || ''}</td>
                    <td>${bill.so_bill}</td>
                    <td>${tlUnpacked.toFixed(2)}</td>
                    <td>${ttUnpacked.toFixed(2)}</td>
                    <td>${billKien}</td>
                    <td>${totalPacked}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Xuất Excel
        document.getElementById('exportBtn').addEventListener('click', function() {
            const table = document.getElementById('resultTable');
            const workbook = XLSX.utils.table_to_book(table);
            XLSX.writeFile(workbook, 'Don_hang_chua_xep_du.xlsx');
        });

        // Gọi hàm lấy dữ liệu khi trang được tải
        window.onload = fetchData;
    </script>
</body>
</html>
