<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Báo cáo Bill thiếu</title>
<style>
  body { font-family: Arial, sans-serif; margin: 10px; }
  h1 { font-size: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 4px 6px; font-size: 13px; }
  th { background: #f0f0f0; }
  tr:nth-child(even) { background: #fafafa; }
  .stats { margin-top: 10px; font-size: 14px; }
  .status-missing { color: red; font-weight: bold; }
  .status-notplaced { color: #b30086; font-weight: bold; }
</style>
</head>
<body>
<h1>Báo cáo Bill thiếu</h1>
<div class="stats" id="stats">Đang tải...</div>
<table id="table">
  <thead>
    <tr>
      <th>Bill</th>
      <th>Khách hàng</th>
      <th>Tên mặt hàng</th>
      <th>Số kiện (Bill)</th>
      <th>Đã xếp (Xếp hàng)</th>
      <th>Còn thiếu</th>
      <th>Trạng thái thiếu</th>
      <th>Tỉnh trả</th>
      <th>Xã trả</th>
      <th>Nơi trả</th>
      <th>Ngày (Bill)</th>
      <th>Ghi chú</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
function getAllParams(prefix) {
  const params = new URLSearchParams(location.search);
  let parts = [];
  for (let [k,v] of params.entries()) {
    if (k.startsWith(prefix)) {
      parts.push(v);
    }
  }
  return parts.length ? JSON.parse(decodeURIComponent(parts.join(''))) : [];
}

function safe(val) {
  return val == null ? '' : String(val);
}

window.onload = function() {
  const bills = getAllParams('bills');
  const details = getAllParams('details');
  const missing = getAllParams('missing');

  const sumBill = bills.reduce((s, r) => s + Number(r['Số kiện'] || 0), 0);
  const sumShipped = details.reduce((s, r) => s + Number(r['Số kiện'] || 0), 0);
  const sumMissing = missing.reduce((s, r) => s + Number(r['Còn thiếu'] || 0), 0);

  const nNotPlaced = missing.filter(r => safe(r['Trạng thái thiếu']) === 'Chưa xếp').length;

  document.getElementById('stats').innerHTML = `
    <div>Tổng Bill: <b>${bills.length}</b></div>
    <div>Dòng Xếp hàng: <b>${details.length}</b></div>
    <div>Bill còn thiếu: <b>${missing.length}</b></div>
    <div>Chưa xếp: <b>${nNotPlaced}</b></div>
    <div>Tổng Số kiện (Bill): <b>${sumBill}</b></div>
    <div>Đã xếp: <b>${sumShipped}</b></div>
    <div>Còn thiếu: <b>${sumMissing}</b></div>
  `;

  const tbody = document.querySelector('#table tbody');
  missing.forEach(r => {
    const tr = document.createElement('tr');
    const status = safe(r['Trạng thái thiếu']);
    tr.innerHTML = `
      <td>${safe(r['Bill'])}</td>
      <td>${safe(r['Khách hàng'])}</td>
      <td>${safe(r['Tên mặt hàng'])}</td>
      <td>${safe(r['Số kiện (Bill)'])}</td>
      <td>${safe(r['Đã xếp (Xếp hàng)'])}</td>
      <td>${safe(r['Còn thiếu'])}</td>
      <td class="${status === 'Chưa xếp' ? 'status-notplaced' : 'status-missing'}">${status}</td>
      <td>${safe(r['Tỉnh trả'])}</td>
      <td>${safe(r['Xã trả'])}</td>
      <td>${safe(r['Nơi trả'])}</td>
      <td>${safe(r['Ngày (Bill)'])}</td>
      <td>${safe(r['Ghi chú'])}</td>
    `;
    tbody.appendChild(tr);
  });
};
</script>
</body>
</html>
