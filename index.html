<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>H√≥a ƒë∆°n V·∫≠n T·∫£i ECO</title>
<style>
@page {
    size: A5 landscape;
    margin: 5mm;
}
body {
    font-family: Arial, sans-serif;
    font-size: 12px;
    margin: 0;
    padding: 10px;
}

/* Print-specific styles */
@media print {
    body {
        margin: 0;
        padding: 0;
        background: white;
    }
    
    .no-print {
        display: none !important;
    }
    
    .invoice {
        border: 2px solid #000;
        margin: 0;
        padding: 8px;
        width: 100%;
        box-sizing: border-box;
        page-break-inside: avoid;
    }
    
    /* Ensure only the invoice prints */
    body > *:not(.invoice):not(script) {
        display: none !important;
    }
    
    /* Override any margins/padding that might interfere */
    * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
}
.invoice {
    width: 100%;
    border: 2px solid #000;
    padding: 8px;
    box-sizing: border-box;
}
table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 2px;
}
td, th {
    border: 1px solid #000;
    padding: 4px;
    vertical-align: top;
    font-size: 11px;
}
.no-border td {
    border: none;
    padding: 2px;
}
.bold { font-weight: bold; }
.center { text-align: center; }
.right { text-align: right; }
.qr {
    width: 60px;
    height: 60px;
    background-size: cover;
    background-position: center;
    border: 1px solid #ccc;
    display: inline-block;
}
h1 {
    margin: 0;
    font-size: 18px;
}
h2 {
    margin: 0;
    font-size: 14px;
}
.error {
    color: red;
    font-weight: bold;
}
.warning {
    color: orange;
    font-style: italic;
}
.header-code {
    font-size: 16px;
    font-weight: bold;
    text-align: center;
}
.company-name {
    font-size: 14px;
    font-weight: bold;
}
.hotline {
    font-size: 11px;
}
</style>
</head>
<body>

<div class="invoice">
    <!-- Header -->
    <table class="no-border">
        <tr>
            <td style="width: 65%;">
                <div class="company-name">V·∫¨N T·∫¢I ECO</div>
                <div style="font-size: 11px;">V·∫¨N CHUY·ªÇN H√ÄNG H√ìA B·∫ÆC - NAM</div>
                <div class="hotline">Hotline: <span class="bold">0946 936 999 - 0888 805 625</span></div>
            </td>
            <td class="right">
                <div class="header-code">*<span id="maVanDon"></span>*</div>
                <div style="font-size: 10px; margin-top: 5px;" id="maVanDonDisplay"></div>
            </td>
        </tr>
    </table>

    <!-- M√£ KH -->
    <table>
        <tr>
            <td style="width: 25%;">M√£ KH g·ª≠i: <span id="maKHGui"></span></td>
            <td style="width: 25%;">M√£ BC g·ª≠i: <span id="maBCGui"></span></td>
            <td style="width: 25%;">M√£ KH nh·∫≠n: <span id="maKHNhan"></span></td>
            <td style="width: 25%;">M√£ BC nh·∫≠n: <span id="maBCNhan"></span></td>
        </tr>
        <tr>
            <td colspan="2">
                T√™n kh√°ch g·ª≠i: <span id="tenNguoiGui"></span><br>
                ƒê·ªãa ch·ªâ: <span id="diaChiNguoiGui"></span>
            </td>
            <td colspan="2">
                T√™n kh√°ch nh·∫≠n: <span id="tenNguoiNhan"></span><br>
                ƒê·ªãa ch·ªâ: <span id="diaChiNguoiNhan"></span>
            </td>
        </tr>
        <tr>
            <td>Qu·∫≠n/ Huy·ªán: <span id="quanHuyenGui"></span></td>
            <td>T·ªânh/ TP: <span id="tpGui"></span></td>
            <td>Qu·∫≠n/ Huy·ªán: <span id="quanHuyenNhan"></span></td>
            <td>T·ªânh/ TP: <span id="tpNhan"></span></td>
        </tr>
        <tr>
            <td>S·ªë ƒëi·ªán tho·∫°i: <span id="soDTGui"></span></td>
            <td>T√™n li√™n h·ªá: <span id="tenLHGui"></span></td>
            <td>S·ªë ƒëi·ªán tho·∫°i: <span id="soDTNhan"></span></td>
            <td>T√™n li√™n h·ªá: <span id="tenLHNhan"></span></td>
        </tr>
    </table>

    <!-- H√†ng h√≥a -->
    <table>
        <tr>
            <td colspan="2">M√¥ t·∫£ h√†ng ho√°: <span id="moTaHang"></span></td>
            <td>H√¨nh th·ª©c thanh to√°n: <span id="thanhToan"></span></td>
            <td>C∆∞·ªõc ch√≠nh: <span id="cuocChinh"></span></td>
        </tr>
        <tr>
            <td>D·ªãch v·ª• c·ªông th√™m: <span id="dichVuThem"></span></td>
            <td>T·ªïng c∆∞·ªõc: <span id="tongThu"></span></td>
            <td colspan="2" class="bold">T·ªïng ph·∫£i thu khi ph√°t: <span id="tongThu2"></span></td>
        </tr>
    </table>

    <!-- Th√¥ng tin ki·ªán -->
    <table>
        <tr>
            <td>S·ªë ki·ªán: <span id="soKien"></span></td>
            <td>Tr·ªçng l∆∞·ª£ng th·ª±c: <span id="tlThuc"></span></td>
            <td>Tr·ªçng l∆∞·ª£ng quy ƒë·ªïi: <span id="tlQDoi"></span></td>
            <td>Thu h·ªô: <span id="thuHo"></span></td>
        </tr>
        <tr>
            <td>Khai gi√°: <span id="khaiGia"></span></td>
            <td colspan="3">Ghi ch√∫: <span id="ghiChu"></span></td>
        </tr>
    </table>

    <!-- D·ªãch v·ª• & QR -->
    <table>
        <tr>
            <td>D·ªãch v·ª•: <span id="dichVu"></span></td>
            <td>D.v·ª• gtgt: <span id="dichVuNhanh"></span></td>
            <td rowspan="3" class="center" style="width: 80px;">
                <div class="qr" id="qrCode"></div><br>
                <div style="font-size: 9px; margin-top: 2px;">Qu√©t QR xem ch√≠nh s√°ch</div>
            </td>
            <td>M√£ nh√¢n vi√™n nh·∫≠n</td>
            <td>M√£ nh√¢n vi√™n ph√°t</td>
        </tr>
        <tr>
            <td>Ng√†y gi·ªù g·ª≠i: <span id="ngayGui"></span></td>
            <td>Ng√†y gi·ªù nh·∫≠n: <span id="ngayNhan"></span></td>
            <td>Chuy·ªÉn ho√†n ‚ñ° H·ªßy ‚ñ°</td>
        </tr>
        <tr>
            <td colspan="2" class="center">H·ªç t√™n & ch·ªØ k√Ω ng∆∞·ªùi g·ª≠i</td>
            <td colspan="2" class="center">H·ªç t√™n & ch·ªØ k√Ω ng∆∞·ªùi nh·∫≠n</td>
        </tr>
    </table>
</div>

<p class="center no-print">
    <button onclick="printInvoice()" style="padding: 10px 20px; font-size: 14px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
        üñ® In h√≥a ƒë∆°n A5
    </button>
</p>

<script>
// Error handling utilities
function logError(message, context) {
    console.error(`ECO Invoice Error: ${message}`, context);
}

function showUserError(message) {
    // Could be enhanced with toast notifications or modal dialogs
    alert(`L·ªói: ${message}`);
}

// Safe parameter extraction with validation
function getParam(name) {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const value = urlParams.get(name);
        return value ? value.trim() : '';
    } catch (error) {
        logError(`Failed to get parameter: ${name}`, error);
        return '';
    }
}

// Validation functions
function validateRequired(value, fieldName) {
    if (!value || value.trim() === '') {
        return {
            isValid: false,
            message: `${fieldName} l√† b·∫Øt bu·ªôc`
        };
    }
    return { isValid: true };
}

function validatePhone(phone) {
    if (!phone) return { isValid: true }; // Optional field
    
    const phoneRegex = /^[0-9\s\-\+\(\)]{10,15}$/;
    if (!phoneRegex.test(phone.replace(/\s/g, ''))) {
        return {
            isValid: false,
            message: 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá'
        };
    }
    return { isValid: true };
}

function validateNumeric(value, fieldName) {
    if (!value) return { isValid: true }; // Optional field
    
    if (isNaN(value) || value < 0) {
        return {
            isValid: false,
            message: `${fieldName} ph·∫£i l√† s·ªë h·ª£p l·ªá`
        };
    }
    return { isValid: true };
}

function validateDate(dateStr) {
    if (!dateStr) return { isValid: true }; // Optional field
    
    // Accept various Vietnamese date formats
    const dateFormats = [
        /^\d{1,2}\/\d{1,2}\/\d{4}$/,
        /^\d{1,2}-\d{1,2}-\d{4}$/,
        /^\d{4}-\d{1,2}-\d{1,2}$/
    ];
    
    const isValidFormat = dateFormats.some(format => format.test(dateStr));
    if (!isValidFormat) {
        return {
            isValid: false,
            message: 'ƒê·ªãnh d·∫°ng ng√†y kh√¥ng h·ª£p l·ªá (dd/mm/yyyy)'
        };
    }
    return { isValid: true };
}

// Safe element setting with error handling
function safeSet(elementId, value, options = {}) {
    try {
        const element = document.getElementById(elementId);
        if (!element) {
            logError(`Element not found: ${elementId}`);
            return false;
        }

        // Handle different types of content
        const displayValue = value || (options.defaultValue || '');
        
        if (options.isHTML) {
            element.innerHTML = displayValue;
        } else {
            element.textContent = displayValue;
        }

        // Apply styling based on validation
        if (options.isError) {
            element.className = (element.className || '') + ' error';
            element.title = options.errorMessage || 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá';
        } else if (options.isWarning) {
            element.className = (element.className || '') + ' warning';
            element.title = options.warningMessage || 'C·∫ßn ki·ªÉm tra d·ªØ li·ªáu';
        }

        return true;
    } catch (error) {
        logError(`Failed to set element ${elementId}`, { error, value });
        return false;
    }
}

// Enhanced set function with validation
function setWithValidation(elementId, value, validator, fieldName) {
    const validation = validator ? validator(value, fieldName) : { isValid: true };
    
    safeSet(elementId, value, {
        isError: !validation.isValid,
        errorMessage: validation.message,
        defaultValue: validation.isValid ? '' : `[${validation.message}]`
    });
    
    if (!validation.isValid) {
        logError(`Validation failed for ${fieldName}`, validation.message);
    }
}

// QR Code generation with error handling
function generateQRCode(data) {
    if (!data) {
        logError('No data provided for QR code generation');
        return;
    }

    try {
        const qrElement = document.getElementById("qrCode");
        if (!qrElement) {
            logError('QR code element not found');
            return;
        }

        const encodedData = encodeURIComponent(data);
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=60x60&data=${encodedData}`;
        
        qrElement.style.backgroundImage = `url('${qrUrl}')`;
        
        // Add error handling for failed image load
        const img = new Image();
        img.onload = function() {
            // QR code loaded successfully
        };
        img.onerror = function() {
            logError('Failed to load QR code image');
            qrElement.style.backgroundColor = '#f0f0f0';
            qrElement.textContent = 'QR Error';
        };
        img.src = qrUrl;
        
    } catch (error) {
        logError('QR code generation failed', error);
    }
}

// Main initialization function
function initializeInvoice() {
    try {
        // Collect all form data
        const formData = {
            maVanDon: getParam("maVanDon"),
            maKHGui: getParam("maKHGui"),
            maBCGui: getParam("maBCGui"),
            maKHNhan: getParam("maKHNhan"),
            maBCNhan: getParam("maBCNhan"),
            tenNguoiGui: getParam("tenNguoiGui"),
            diaChiNguoiGui: getParam("diaChiNguoiGui"),
            tenNguoiNhan: getParam("tenNguoiNhan"),
            diaChiNguoiNhan: getParam("diaChiNguoiNhan"),
            quanHuyenGui: getParam("quanHuyenGui"),
            tpGui: getParam("tpGui"),
            quanHuyenNhan: getParam("quanHuyenNhan"),
            tpNhan: getParam("tpNhan"),
            soDTGui: getParam("soDTGui"),
            tenLHGui: getParam("tenLHGui"),
            soDTNhan: getParam("soDTNhan"),
            tenLHNhan: getParam("tenLHNhan"),
            moTaHang: getParam("moTaHang"),
            thanhToan: getParam("thanhToan"),
            cuocChinh: getParam("cuocChinh"),
            dichVuThem: getParam("dichVuThem"),
            tongThu: getParam("tongThu"),
            soKien: getParam("soKien"),
            tlThuc: getParam("tlThuc"),
            tlQDoi: getParam("tlQDoi"),
            thuHo: getParam("thuHo"),
            khaiGia: getParam("khaiGia"),
            dichVu: getParam("dichVu"),
            dichVuNhanh: getParam("dichVuNhanh"),
            ngayGui: getParam("ngayGui"),
            ngayNhan: getParam("ngayNhan"),
            ghiChu: getParam("ghiChu")
        };

        // Validate and set required fields
        setWithValidation("maVanDon", formData.maVanDon, validateRequired, "M√£ v·∫≠n ƒë∆°n");
        setWithValidation("tenNguoiGui", formData.tenNguoiGui, validateRequired, "T√™n ng∆∞·ªùi g·ª≠i");
        setWithValidation("tenNguoiNhan", formData.tenNguoiNhan, validateRequired, "T√™n ng∆∞·ªùi nh·∫≠n");

        // Set duplicate fields for header
        safeSet("maVanDonDisplay", formData.maVanDon);

        // Validate and set optional fields with validation
        setWithValidation("soDTGui", formData.soDTGui, validatePhone, "S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi g·ª≠i");
        setWithValidation("soDTNhan", formData.soDTNhan, validatePhone, "S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi nh·∫≠n");
        setWithValidation("soKien", formData.soKien, validateNumeric, "S·ªë ki·ªán");
        setWithValidation("tlThuc", formData.tlThuc, validateNumeric, "Tr·ªçng l∆∞·ª£ng th·ª±c");
        setWithValidation("tlQDoi", formData.tlQDoi, validateNumeric, "Tr·ªçng l∆∞·ª£ng quy ƒë·ªïi");
        setWithValidation("cuocChinh", formData.cuocChinh, validateNumeric, "C∆∞·ªõc ch√≠nh");
        setWithValidation("tongThu", formData.tongThu, validateNumeric, "T·ªïng thu");
        setWithValidation("thuHo", formData.thuHo, validateNumeric, "Thu h·ªô");
        setWithValidation("khaiGia", formData.khaiGia, validateNumeric, "Khai gi√°");
        setWithValidation("ngayGui", formData.ngayGui, validateDate, "Ng√†y g·ª≠i");
        setWithValidation("ngayNhan", formData.ngayNhan, validateDate, "Ng√†y nh·∫≠n");

        // Set remaining fields without specific validation
        const simpleFields = [
            "maKHGui", "maBCGui", "maKHNhan", "maBCNhan",
            "diaChiNguoiGui", "diaChiNguoiNhan", "quanHuyenGui", "tpGui",
            "quanHuyenNhan", "tpNhan", "tenLHGui", "tenLHNhan",
            "moTaHang", "thanhToan", "dichVuThem", "dichVu", 
            "dichVuNhanh", "ghiChu"
        ];

        simpleFields.forEach(field => {
            safeSet(field, formData[field]);
        });

        // Set the duplicate total field
        safeSet("tongThu2", formData.tongThu);

        // Generate QR code
        if (formData.maVanDon) {
            generateQRCode(formData.maVanDon);
        }

        // Log successful initialization
        console.log('ECO Invoice initialized successfully');

    } catch (error) {
        logError('Failed to initialize invoice', error);
        showUserError('C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu h√≥a ƒë∆°n. Vui l√≤ng th·ª≠ l·∫°i.');
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initializeInvoice);

// Enhanced print function for A5 invoice only
function printInvoice() {
    try {
        // Validate that essential data exists before printing
        const maVanDon = document.getElementById('maVanDon').textContent.trim();
        if (!maVanDon) {
            showUserError('Kh√¥ng th·ªÉ in: Thi·∫øu m√£ v·∫≠n ƒë∆°n');
            return;
        }

        console.log('Preparing to print A5 invoice...');
        
        // Set document title for print job
        const originalTitle = document.title;
        document.title = `H√≥a ƒë∆°n ECO - ${maVanDon}`;
        
        // Trigger print
        window.print();
        
        // Restore original title
        document.title = originalTitle;
        
    } catch (error) {
        logError('Print function failed', error);
        showUserError('C√≥ l·ªói x·∫£y ra khi in h√≥a ƒë∆°n. Vui l√≤ng th·ª≠ l·∫°i.');
    }
}

// Handle print events with better logging
window.addEventListener('beforeprint', function() {
    console.log('Starting A5 invoice print...');
    // Hide any elements that shouldn't print
    document.body.classList.add('printing');
});

window.addEventListener('afterprint', function() {
    console.log('A5 invoice print completed');
    // Restore normal view
    document.body.classList.remove('printing');
});

// Handle page errors
window.addEventListener('error', function(event) {
    logError('Page error occurred', {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno
    });
});

</script>

</body>
</html>
